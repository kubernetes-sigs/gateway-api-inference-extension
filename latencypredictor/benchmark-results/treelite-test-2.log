============================= test session starts ==============================
platform linux -- Python 3.9.25, pytest-8.4.2, pluggy-1.6.0 -- /usr/local/bin/python3.9
cachedir: .pytest_cache
rootdir: /app
plugins: asyncio-1.2.0, anyio-4.12.0
asyncio: mode=strict, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 28 items

test_dual_server_client.py::test_prediction_server_healthz Waiting for prediction server...
Waiting for training server...
PASSED
test_dual_server_client.py::test_training_server_healthz PASSED
test_dual_server_client.py::test_prediction_server_readyz PASSED
test_dual_server_client.py::test_training_server_readyz PASSED
test_dual_server_client.py::test_prediction_server_status Prediction server using model type: xgboost
Quantile: 0.9
Models ready: True
Models exist: {'ttft_model': True, 'tpot_model': True}
PASSED
test_dual_server_client.py::test_training_server_model_info Training server using model type: xgboost
PASSED
test_dual_server_client.py::test_training_server_models_list Model ttft: exists=True, size=143390 bytes
Model tpot: exists=True, size=142823 bytes
Model ttft_treelite: exists=False, size=0 bytes
Model tpot_treelite: exists=False, size=0 bytes
PASSED
test_dual_server_client.py::test_model_download_from_training_server Successfully downloaded ttft model (143390 bytes)
Successfully downloaded tpot model (142823 bytes)
PASSED
test_dual_server_client.py::test_treelite_models_on_training_server Testing TreeLite models for xgboost...
TTFT TreeLite model endpoint returned status 404
TPOT TreeLite model endpoint returned status 404
PASSED
test_dual_server_client.py::test_lightgbm_endpoints_on_training_server Skipping LightGBM endpoint tests - not using LightGBM model
PASSED
test_dual_server_client.py::test_add_training_data_to_training_server Successfully sent training data to training server
PASSED
test_dual_server_client.py::test_prediction_server_model_sync Model reload result: synced=False, loaded=True
Prediction server models are ready!
PASSED
test_dual_server_client.py::test_prediction_via_prediction_server Prediction successful: TTFT=10.00ms, TPOT=10.00ms
Model type: xgboost
PASSED
test_dual_server_client.py::test_bulk_prediction_strict Testing bulk prediction strict endpoint...
✓ Bulk prediction strict endpoint test passed
PASSED
test_dual_server_client.py::test_bulk_prediction_with_validation_errors Testing bulk prediction validation error handling...
✓ Bulk prediction correctly failed when any request had validation errors
PASSED
test_dual_server_client.py::test_bulk_prediction_all_valid Testing bulk prediction with all valid requests...
✓ Bulk prediction succeeded with all valid requests
PASSED
test_dual_server_client.py::test_prediction_missing_prefix_cache_score ✓ Prediction correctly failed when prefix_cache_score was missing
PASSED
test_dual_server_client.py::test_training_server_metrics Training server metrics endpoint working correctly
✓ Prefix cache score feature found in metrics
PASSED
test_dual_server_client.py::test_model_consistency_between_servers Model type consistent across servers: xgboost
PASSED
test_dual_server_client.py::test_model_specific_endpoints_on_training_server Testing XGBoost tree endpoints on training server...
✓ TTFT XGBoost trees available: 200 trees
✓ TPOT XGBoost trees available: 200 trees
PASSED
test_dual_server_client.py::test_dual_server_quantile_regression_learns_distribution Relative-err accuracy (≤15%): 86.5%
Coverage: TTFT=0.870, TPOT=0.895 (target 0.900 ± 0.05)
PASSED
test_dual_server_client.py::test_prediction_server_stress_test Running prediction server stress test...
Waiting for 100007 prediction requests to complete...
Target QPS: 1000.0, Actual QPS: 1000.1

==================================================
PREDICTION SERVER STRESS TEST RESULTS
==================================================
Total Requests: 100007
Successful: 100007 (100.0%)
Failed: 0 (0.0%)
Average Response Time: 8.41ms

Model Types in Predictions:
  xgboost: 100007

Status Code Distribution:
  200: 100007

Response Time Percentiles:
  P50: 3.83ms
  P95: 26.26ms
  P99: 113.47ms
Prediction server stress test completed with 100.0% success rate
PASSED
test_dual_server_client.py::test_bulk_prediction_stress_test Running bulk prediction stress test...

Testing with batch size 5...
Waiting for 99998 bulk prediction requests to complete...
Target RPS: 1000.0, Actual RPS: 1000.0
Total Predictions: 499990, Predictions/sec: 4999.9

==================================================
BULK PREDICTION STRESS TEST RESULTS
==================================================
Total Bulk Requests: 99998
Successful: 99998 (100.0%)
Failed: 0 (0.0%)
Total Individual Predictions: 499990
Total Batch Size: 499990
Average Response Time: 13.36ms
Average Batch Size: 5.0
Prediction Success Rate: 100.0%

Status Code Distribution:
  200: 99998

Response Time Percentiles:
  P50: 6.88ms
  P95: 52.47ms
  P99: 119.33ms
Bulk prediction stress test (batch size 5) completed with 100.0% success rate

Testing with batch size 10...
Waiting for 100001 bulk prediction requests to complete...
Target RPS: 1000.0, Actual RPS: 1000.0
Total Predictions: 1000010, Predictions/sec: 10000.1

==================================================
BULK PREDICTION STRESS TEST RESULTS
==================================================
Total Bulk Requests: 100001
Successful: 100001 (100.0%)
Failed: 0 (0.0%)
Total Individual Predictions: 1000010
Total Batch Size: 1000010
Average Response Time: 22.84ms
Average Batch Size: 10.0
Prediction Success Rate: 100.0%

Status Code Distribution:
  200: 100001

Response Time Percentiles:
  P50: 6.48ms
  P95: 142.48ms
  P99: 224.02ms
Bulk prediction stress test (batch size 10) completed with 100.0% success rate

Testing with batch size 25...
Waiting for 100005 bulk prediction requests to complete...
Target RPS: 1000.0, Actual RPS: 1000.0
Total Predictions: 2500125, Predictions/sec: 25001.2

==================================================
BULK PREDICTION STRESS TEST RESULTS
==================================================
Total Bulk Requests: 100005
Successful: 100005 (100.0%)
Failed: 0 (0.0%)
Total Individual Predictions: 2500125
Total Batch Size: 2500125
Average Response Time: 37.84ms
Average Batch Size: 25.0
Prediction Success Rate: 100.0%

Status Code Distribution:
  200: 100005

Response Time Percentiles:
  P50: 9.47ms
  P95: 208.16ms
  P99: 291.28ms
Bulk prediction stress test (batch size 25) completed with 100.0% success rate
PASSED
test_dual_server_client.py::test_large_batch_prediction_stress_test Running bulk prediction stress test...

Testing with batch size 1000...
Waiting for 9999 bulk prediction requests to complete...
Target RPS: 100.0, Actual RPS: 100.0
Total Predictions: 9999000, Predictions/sec: 99990.0

==================================================
BULK PREDICTION STRESS TEST RESULTS
==================================================
Total Bulk Requests: 9999
Successful: 9999 (100.0%)
Failed: 0 (0.0%)
Total Individual Predictions: 9999000
Total Batch Size: 9999000
Average Response Time: 36.76ms
Average Batch Size: 1000.0
Prediction Success Rate: 100.0%

Status Code Distribution:
  200: 9999

Response Time Percentiles:
  P50: 28.60ms
  P95: 77.74ms
  P99: 182.68ms
Bulk prediction stress test (batch size 1000) completed with 100.0% success rate
PASSED
test_dual_server_client.py::test_end_to_end_workflow Testing end-to-end workflow...
Step 1: Sending training data to training server...
Step 2: Waiting for training...
Step 3: Syncing models to prediction server...
Step 4: Making predictions...
  Prediction 1: TTFT=1801.03ms, TPOT=536.03ms (prefix_cache=0.81)
  Prediction 2: TTFT=949.26ms, TPOT=293.71ms (prefix_cache=0.07)
  Prediction 3: TTFT=1451.05ms, TPOT=409.88ms (prefix_cache=0.88)
  Prediction 4: TTFT=550.66ms, TPOT=180.41ms (prefix_cache=0.43)
  Prediction 5: TTFT=828.82ms, TPOT=265.75ms (prefix_cache=0.78)
✓ End-to-end workflow completed successfully!
PASSED
test_dual_server_client.py::test_server_configuration Testing server configuration...
Prediction server: HTTP-based Quantile Latency Predictor is running
  Model type: xgboost
  Is ready: True
  Sync interval: 10s
  Training server URL: http://training-service:8000
Training server: Latency Predictor is running.
  Model type: xgboost
PASSED
test_dual_server_client.py::test_training_server_flush_api Testing training server flush API...
Step 1: Checking initial data status...
  Initial training samples: TTFT=2729, TPOT=2729
  Initial test samples: TTFT=341, TPOT=341
Step 2: Adding training data...
  Added 100 training samples
Step 3: Verifying data was added...
  After adding - Training: 5644, Test: 696, Total: 6340
Step 4: Testing flush with only training data...
  Flushed 2822 TTFT training samples
  Flushed 2822 TPOT training samples
  Test samples flushed: 0 TTFT, 0 TPOT (should be 0)
  After training flush - Training: 0, Test: 696
Step 5: Adding more training data...
Step 6: Testing flush everything...
  Complete flush message: Successfully flushed: 42 TTFT and 42 TPOT training samples, 356 TTFT and 356 TPOT test samples, all metric scores
  After complete flush - Training: 0, Test: 0
Step 7: Testing default flush (no body)...
  Default flush result: Successfully flushed: 17 TTFT and 17 TPOT training samples, 3 TTFT and 3 TPOT test samples, all metric scores
Step 8: Testing flush with only test data...
  Test data flush: 8 TTFT, 8 TPOT
  After test flush - Training: 84, Test: 0
Step 9: Testing bucket distribution in status...
  Bucket distribution available: 0 buckets with data
✓ Flush API tests passed!
PASSED
test_dual_server_client.py::test_training_server_flush_error_handling Testing flush API error handling...
✓ Invalid JSON handled correctly
✓ Flush error handling tests passed!
PASSED

======================== 28 passed in 563.12s (0:09:23) ========================
