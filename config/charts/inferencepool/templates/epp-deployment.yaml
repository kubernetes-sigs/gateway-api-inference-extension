{{/*
  This template conditionally creates one of two Deployments
  based on the value of .Values.provider.standalone.
*/}}

{{- if not .Values.provider.standalone }}
{{/*
  This block is rendered if .Values.provider.standalone is false (or not set).
  This is the "default" deployment.
*/}}
 ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "gateway-api-inference-extension.labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.inferenceExtension.replicas | default 1 }}
  strategy:
    # The current recommended EPP deployment pattern is to have a single active replica. This ensures 
    # optimal performance of the stateful operations such prefix cache aware scorer.
    # The Recreate strategy the old replica is killed immediately, and allow the new replica(s) to 
    # quickly take over. This is particularly important in the high availability set up with leader
    # election, as the rolling update strategy would prevent the old leader being killed because 
    # otherwise the maxUnavailable would be 100%.
    type: Recreate
  selector:
    matchLabels:
      {{- include "gateway-api-inference-extension.selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels:
        {{- include "gateway-api-inference-extension.selectorLabels" . | nindent 8 }}
    spec:
      serviceAccountName: {{ include "gateway-api-inference-extension.name" . }}
      # Conservatively, this timeout should mirror the longest grace period of the pods within the pool
      terminationGracePeriodSeconds: 130
      containers:
      - name: epp
        image: {{ .Values.inferenceExtension.image.hub }}/{{ .Values.inferenceExtension.image.name }}:{{ .Values.inferenceExtension.image.tag }}
        imagePullPolicy: {{ .Values.inferenceExtension.image.pullPolicy | default "Always" }}
        args:
        - --pool-name
        - {{ .Release.Name }}
        # The pool namespace is optional because EPP can default to the NAMESPACE env var.
        # We still keep this here so that the template works with older versions of EPP, or other
        # distros of EPP which may not have implemented the NAMESPACE env var defaulting behavior.
        - --pool-namespace
        - {{ .Release.Namespace }}
        {{- if ne .Values.inferencePool.apiVersion "inference.networking.k8s.io" }}
        - --pool-group
        - "{{ (split "/" .Values.inferencePool.apiVersion)._0 }}"
        {{- end }}
        - --zap-encoder
        - "json"
        - --config-file
        - "/config/{{ .Values.inferenceExtension.pluginsConfigFile }}"
        {{- if eq (.Values.inferencePool.modelServerType | default "vllm") "triton-tensorrt-llm" }}
        - --total-queued-requests-metric
        - "nv_trt_llm_request_metrics{request_type=waiting}"
        - --kv-cache-usage-percentage-metric
        - "nv_trt_llm_kv_cache_block_metrics{kv_cache_block_type=fraction}"
        - --lora-info-metric
        - "" # Set an empty metric to disable LoRA metric scraping as they are not supported by Triton yet.
        {{- end }}
        {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
        - --ha-enable-leader-election
        {{- end }}
        # Pass additional flags via the inferenceExtension.flags field in values.yaml.
        {{- range .Values.inferenceExtension.flags }}
        - "--{{ .name }}"
        - "{{ .value }}"
        {{- end }}
        {{- if .Values.inferenceExtension.tracing.enabled }}
        - --tracing=true
        {{- else }}
        - --tracing=false
        {{- end }}
        {{- if not .Values.inferenceExtension.monitoring.prometheus.enabled }}
        - --metrics-endpoint-auth=false
        {{- end }}
        ports:
        - name: grpc
          containerPort: 9002
        - name: grpc-health
          containerPort: 9003
        - name: metrics
          containerPort: 9090
        {{- if .Values.inferenceExtension.extraContainerPorts }}
        {{- toYaml .Values.inferenceExtension.extraContainerPorts | nindent 8 }}
        {{- end }}
        livenessProbe:
          {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
          grpc:
            port: 9003
            service: liveness
          {{- else }}
          grpc:
            port: 9003
            service: inference-extension
          {{- end }}
          initialDelaySeconds: 5
          periodSeconds: 10
        readinessProbe:
          {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
          grpc:
            port: 9003
            service: readiness
          {{- else }}
          grpc:
            port: 9003
            service: inference-extension
          {{- end }}
          periodSeconds: 2

        env:
        - name: NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        {{- if .Values.inferenceExtension.tracing.enabled }}
        - name: OTEL_SERVICE_NAME
          value: "gateway-api-inference-extension"
        - name: OTEL_EXPORTER_OTLP_ENDPOINT
          value: {{ .Values.inferenceExtension.tracing.otelExporterEndpoint | quote }}
        - name: OTEL_TRACES_EXPORTER
          value: "otlp"
        - name: OTEL_RESOURCE_ATTRIBUTES_NODE_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: spec.nodeName
        - name: OTEL_RESOURCE_ATTRIBUTES_POD_NAME
          valueFrom:
            fieldRef:
              apiVersion: v1
              fieldPath: metadata.name
        - name: OTEL_RESOURCE_ATTRIBUTES
          value: 'k8s.namespace.name=$(NAMESPACE),k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME)'
        - name: OTEL_TRACES_SAMPLER
          value: {{ .Values.inferenceExtension.tracing.sampling.sampler | quote }}
        - name: OTEL_TRACES_SAMPLER_ARG
          value: {{ .Values.inferenceExtension.tracing.sampling.samplerArg | quote }}
        {{- end }}
        {{- if .Values.inferenceExtension.env }}
        {{- toYaml .Values.inferenceExtension.env | nindent 8 }}
        {{- end }}
        volumeMounts:
        - name: plugins-config-volume
          mountPath: "/config"
      volumes:
      - name: plugins-config-volume
        configMap:
          name: {{ include "gateway-api-inference-extension.name" . }}
      {{- if .Values.inferenceExtension.affinity }}
      affinity:
        {{- toYaml .Values.inferenceExtension.affinity | nindent 8 }}
      {{- end }}
      {{- if .Values.inferenceExtension.tolerations }}
      tolerations:
        {{- toYaml .Values.inferenceExtension.tolerations | nindent 8 }}
      {{- end }}
{{- else }}
{{/*
  This block is rendered if .Values.provider.standalone is true.
  This is the "standalone" envoy-epp deployment.
*/}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}-envoy-epp
  namespace: {{ .Release.Namespace }}
  labels:
    {{ include "gateway-api-inference-extension.envoy-labels" . | nindent 4 }}
data:
  envoy.yaml: |
    admin:
      address:
        socket_address:
          address: 127.0.0.1
          port_value: 19000
      access_log:
        - name: envoy.access_loggers.file
          typed_config:
            "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
            path: /dev/null
    static_resources:
      listeners:
        - name: envoy-proxy-ready-0.0.0.0-19001
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 19001
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: envoy-ready-http
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: prometheus_stats
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/stats/prometheus"
                              route:
                                cluster: "prometheus_stats"
                    http_filters:
                      - name: envoy.filters.http.health_check
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.health_check.v3.HealthCheck
                          pass_through_mode: false
                          headers:
                            - name: ":path"
                              string_match:
                                exact: "/ready"
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
        - name: vllm
          address:
            socket_address:
              address: 0.0.0.0
              port_value: 8081
          per_connection_buffer_limit_bytes: 32768
          access_log:
            - name: envoy.access_loggers.file
              filter:
                response_flag_filter:
                  flags: ["NR"]
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                path: /dev/stdout
                log_format:
                  text_format_source:
                    inline_string: "{\"start_time\":\"%START_TIME%\",\"method\":\"%REQ(:METHOD)%\",...}\n"
          filter_chains:
            - name: vllm
              filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: http-8081
                    route_config:
                      name: vllm
                      virtual_hosts:
                        - name: vllm-default
                          domains: ["*"]
                          routes:
                            - match:
                                prefix: "/"
                              route:
                                cluster: original_destination_cluster
                                timeout: 86400s
                                idle_timeout: 86400s
                                upgrade_configs:
                                  - upgrade_type: websocket
                              typed_per_filter_config:
                                envoy.filters.http.ext_proc:
                                  "@type": type.googleapis.com/envoy.config.route.v3.FilterConfig
                                  config: {}
                    http_filters:
                      - name: envoy.filters.http.ext_proc
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.ext_proc.v3.ExternalProcessor
                          grpc_service:
                            envoy_grpc:
                              cluster_name: ext_proc
                              authority: localhost:9002
                            timeout: 10s
                          processing_mode:
                            request_header_mode: SEND
                            response_header_mode: SEND
                            request_body_mode: FULL_DUPLEX_STREAMED
                            response_body_mode: FULL_DUPLEX_STREAMED
                            request_trailer_mode: SEND
                            response_trailer_mode: SEND
                          message_timeout: 1000s
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
                          suppress_envoy_headers: true
                    http2_protocol_options:
                      max_concurrent_streams: 100
                      initial_stream_window_size: 65536
                      initial_connection_window_size: 1048576
                    use_remote_address: true
                    normalize_path: true
                    merge_slashes: true
                    server_header_transformation: PASS_THROUGH
                    common_http_protocol_options:
                      headers_with_underscores_action: REJECT_REQUEST
                    path_with_escaped_slashes_action: UNESCAPE_AND_REDIRECT
                    access_log:
                      - name: envoy.access_loggers.file
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.access_loggers.file.v3.FileAccessLog
                          path: /dev/stdout
                          log_format:
                            text_format_source:
                              inline_string: "{\"start_time\":\"%START_TIME%\",\"method\":\"%REQ(:METHOD)%\",...}\n"
      clusters:
        - name: prometheus_stats
          type: STATIC
          connect_timeout: 0.250s
          load_assignment:
            cluster_name: prometheus_stats
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 19000
        - name: original_destination_cluster
          type: ORIGINAL_DST
          connect_timeout: 1000s
          lb_policy: CLUSTER_PROVIDED
          circuit_breakers:
            thresholds:
              - max_connections: 40000
                max_pending_requests: 40000
                max_requests: 40000
          original_dst_lb_config:
            use_http_header: true
            http_header_name: x-gateway-destination-endpoint
        - name: ext_proc
          type: STATIC
          connect_timeout: 86400s
          lb_policy: LEAST_REQUEST
          circuit_breakers:
            thresholds:
              - max_connections: 40000
                max_pending_requests: 40000
                max_requests: 40000
                max_retries: 1024
          health_checks:
            - timeout: 2s
              interval: 10s
              unhealthy_threshold: 3
              healthy_threshold: 2
              reuse_connection: true
              grpc_health_check:
                service_name: "envoy.service.ext_proc.v3.ExternalProcessor"
              tls_options:
                alpn_protocols: ["h2"]
          transport_socket:
            name: "envoy.transport_sockets.tls"
            typed_config:
              "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext
              common_tls_context:
                validation_context:
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
              explicit_http_config:
                http2_protocol_options:
                  initial_stream_window_size: 65536
                  initial_connection_window_size: 1048576
          load_assignment:
            cluster_name: ext_proc
            endpoints:
              - locality:
                  region: ext_proc/e2e/0
                lb_endpoints:
                  - endpoint:
                      address:
                        socket_address:
                          address: 127.0.0.1
                          port_value: 9002
                    load_balancing_weight: 1
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "gateway-api-inference-extension.name" . }}-envoy-epp
  namespace:  {{ .Release.Namespace }}
  labels: {{ include "gateway-api-inference-extension.envoy-labels" . | nindent 4 }}
spec:
  replicas: {{ .Values.envoySidecar.replicas | default 1 }}
  selector:
    matchLabels:
      {{ include "gateway-api-inference-extension.envoy-selectorLabels" . | nindent 6 }}
  template:
    metadata:
      labels: {{ include "gateway-api-inference-extension.envoy-selectorLabels" . | nindent 8 }}
      annotations:
        prometheus.io/path: /stats/prometheus
        prometheus.io/port: "19001" # This still correctly refers to the envoy container's metrics port
        prometheus.io/scrape: "true"
    spec:
      serviceAccountName: {{ include "gateway-api-inference-extension.name" . }}
      terminationGracePeriodSeconds: 130
      containers:
        - name: envoy
          image: {{ .Values.envoySidecar.image.hub }}/{{ .Values.envoySidecar.image.name }}:{{ .Values.envoySidecar.image.tag }}
          imagePullPolicy: {{ .Values.envoySidecar.image.pullPolicy | default "Always" }}
          args:
            - "--service-cluster"
            - "{{.Release.Namespace}}/inference-gateway"
            - "--service-node"
            - "envoy"
            - "--log-level"
            - "trace"
            - "--cpuset-threads"
            - "--drain-strategy"
            - "immediate"
            - "--drain-time-s"
            - "60"
            - "-c"
            - "/etc/envoy/envoy.yaml"
          command:
            - envoy
          env:
            - name: ENVOY_NS_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
            - name: ENVOY_POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          ports:
            - containerPort: 8081
              name: http-8081
            - containerPort: 19001
              name: metrics # <-- Envoy's metrics port
          readinessProbe:
            failureThreshold: 1
            httpGet:
              path: /ready
              port: 19001
              scheme: HTTP
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 1
          resources:
            requests:
              cpu: 100m
              memory: 512Mi
          volumeMounts:
            - name: envoy-confog-volume
              mountPath: /etc/envoy
              readOnly: true
        - name: epp
          image: {{ .Values.inferenceExtension.image.hub }}/{{ .Values.inferenceExtension.image.name }}:{{ .Values.inferenceExtension.image.tag }}
          imagePullPolicy: {{ .Values.inferenceExtension.image.pullPolicy | default "Always" }}
          args:
            - --pool-name
            - {{ .Release.Name }}
            - --pool-namespace
            - {{ .Release.Namespace }}
            {{- if ne .Values.inferencePool.apiVersion "inference.networking.k8s.io" }}
            - --pool-group
            - "{{ (split "/" .Values.inferencePool.apiVersion)._0 }}"
            {{- end }}
            - --zap-encoder
            - "json"
            - --config-file
            - "/config/{{ .Values.inferenceExtension.pluginsConfigFile }}"
            {{- if eq (.Values.inferencePool.modelServerType | default "vllm") "triton-tensorrt-llm" }}
            - --total-queued-requests-metric
            - "nv_trt_llm_request_metrics{request_type=waiting}"
            - --kv-cache-usage-percentage-metric
            - "nv_trt_llm_kv_cache_block_metrics{kv_cache_block_type=fraction}"
            - --lora-info-metric
            - "" # Set an empty metric to disable LoRA metric scraping as they are not supported by Triton yet.
            {{- end }}
            {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
            - --ha-enable-leader-election
            {{- end }}
            # Pass additional flags via the inferenceExtension.flags field in values.yaml.
            {{- range .Values.inferenceExtension.flags }}
            - "--{{ .name }}"
            - "{{ .value }}"
            {{- end }}
            {{- if .Values.inferenceExtension.tracing.enabled }}
            - --tracing=true
            {{- else }}
            - --tracing=false
            {{- end }}
            {{- if not .Values.inferenceExtension.monitoring.prometheus.enabled }}
            - --metrics-endpoint-auth=false
            {{- end }}
          ports:
            - name: grpc
              containerPort: 9002
            - name: grpc-health
              containerPort: 9003
            - name: metrics
              containerPort: 9090
          {{- if .Values.inferenceExtension.extraContainerPorts }}
          {{- toYaml .Values.inferenceExtension.extraContainerPorts | nindent 8 }}
          {{- end }}
          livenessProbe:
            {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
            grpc:
              port: 9003
              service: liveness
            {{- else }}
            grpc:
              port: 9003
              service: inference-extension
            {{- end }}
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            {{- if gt (.Values.inferenceExtension.replicas | int) 1 }}
            grpc:
              port: 9003
              service: readiness
            {{- else }}
            grpc:
              port: 9003
              service: inference-extension
            {{- end }}
            periodSeconds: 2

          env:
            - name: NAMESPACE
              valueFrom:
                fieldRef:
                  fieldPath: metadata.namespace
          {{- if .Values.inferenceExtension.tracing.enabled }}
            - name: OTEL_SERVICE_NAME
              value: "gateway-api-inference-extension"
            - name: OTEL_EXPORTER_OTLP_ENDPOINT
              value: {{ .Values.inferenceExtension.tracing.otelExporterEndpoint | quote }}
            - name: OTEL_TRACES_EXPORTER
              value: "otlp"
            - name: OTEL_RESOURCE_ATTRIBUTES_NODE_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: spec.nodeName
            - name: OTEL_RESOURCE_ATTRIBUTES_POD_NAME
              valueFrom:
                fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.name
            - name: OTEL_RESOURCE_ATTRIBUTES
              value: 'k8s.namespace.name=$(NAMESPACE),k8s.node.name=$(OTEL_RESOURCE_ATTRIBUTES_NODE_NAME),k8s.pod.name=$(OTEL_RESOURCE_ATTRIBUTES_POD_NAME)'
            - name: OTEL_TRACES_SAMPLER
              value: {{ .Values.inferenceExtension.tracing.sampling.sampler | quote }}
            - name: OTEL_TRACES_SAMPLER_ARG
              value: {{ .Values.inferenceExtension.tracing.sampling.samplerArg | quote }}
          {{- end }}
          {{- if .Values.inferenceExtension.env }}
          {{- toYaml .Values.inferenceExtension.env | nindent 8 }}
          {{- end }}
          volumeMounts:
            - name: plugins-config-volume
              mountPath: "/config"
      volumes:
        - name: envoy-config-volume
          configMap:
            name: {{ include "gateway-api-inference-extension.name" . }}-envoy
            items:
              - key: envoy.yaml
                path: envoy.yaml
        - name: plugins-config-volume
          configMap:
            name: {{ include "gateway-api-inference-extension.name" . }}
      {{- if .Values.inferenceExtension.affinity }}
      affinity:
        {{- toYaml .Values.inferenceExtension.affinity | nindent 8 }}
      {{- end }}
      {{- if .Values.inferenceExtension.tolerations }}
      tolerations:
        {{- toYaml .Values.inferenceExtension.tolerations | nindent 8 }}
      {{- end }}
---

{{- end }}
